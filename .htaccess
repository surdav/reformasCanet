# ================= Canonical redirects =================
RewriteEngine On

# 0) Letâ€™s Encrypt challenges (no redirects)
RewriteCond %{REQUEST_URI} ^/\.well-known/acme-challenge/ [NC]
RewriteRule ^ - [L]

# 1) Collapse accidental double slashes (not after protocol)
RewriteCond %{REQUEST_URI} ^/{2,}(.+)$
RewriteRule ^ %1 [R=301,L]

# 2) Force HTTPS + non-www
RewriteCond %{HTTPS} !=on [OR]
RewriteCond %{HTTP_HOST} !^reformas-canet-de-mar\.es$ [NC]
RewriteRule ^ https://reformas-canet-de-mar.es%{REQUEST_URI} [R=301,L]

# ================= Disable mod_expires (avoid duplicate Expires/Cache-Control) =================
<IfModule mod_expires.c>
  ExpiresActive Off
</IfModule>

# ================= MIME types =================
AddType image/avif avif
AddType image/webp webp
AddType image/svg+xml svg
AddType font/woff2 woff2
AddType font/woff  woff
AddType application/vnd.ms-fontobject eot
AddType font/ttf   ttf

# ================= Headers (single source of truth) =================
<IfModule mod_headers.c>
  # --- Static assets: strong cache (1y + immutable) ---
  <FilesMatch "\.(?i:css|js|png|jpe?g|gif|svg|webp|avif|ico|woff2?|ttf|eot)$">
    Header always unset Cache-Control
    Header always unset Expires
    Header always unset Pragma
    Header always set   Cache-Control "public, max-age=31536000, immutable"
    Header always set   Expires "Thu, 31 Dec 2037 23:55:55 GMT"
  </FilesMatch>

  # --- HTML/JSON: no persistent cache ---
  <FilesMatch "\.(?i:html?|json)$">
    Header always unset Expires
    Header always set   Cache-Control "no-cache, no-store, must-revalidate"
    Header always set   Pragma "no-cache"
    Header always set   Expires "0"
  </FilesMatch>

  # --- Security headers (safe defaults) ---
  Header always set X-Content-Type-Options "nosniff"
  Header always set Referrer-Policy "strict-origin-when-cross-origin"
  Header always set X-Frame-Options "SAMEORIGIN"
  # Header always set Content-Security-Policy "upgrade-insecure-requests"

  # --- HSTS (HTTPS only) ---
  Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains" env=HTTPS
</IfModule>

# ================= Compression =================
<IfModule mod_brotli.c>
  BrotliCompressionQuality 5
  AddOutputFilterByType BROTLI_COMPRESS text/html text/plain text/css application/javascript application/json image/svg+xml
</IfModule>
<IfModule mod_deflate.c>
  AddOutputFilterByType DEFLATE text/html text/plain text/css application/javascript application/json image/svg+xml
</IfModule>